<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
   PUBLIC "-//mybatis.org//DTD Mapper 3.0/EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.mycom.euum.order.mapper.OrderMapper">



<!-- 작성자 : 최창선, 주문시 보여주는 셀러닉네임 포함, 상품 정보 -->
	<select id="getGoodsInfo" resultType="com.mycom.euum.goods.bean.GoodsBean">

		select goods_num, goods_seller_nickname , member_num, goods_image1, goods_name, 
		goods_format, goods_resolution, goods_size, goods_modify_count,
		 GOODS_PERIOD
		from goods_tbl
		where goods_num=#{goodsNum}

	</select>
	
	<select id="getOrderKeyNum" resultType="int">
		select order_key_num_seq.nextval from dual
	</select>


	<!-- 회원 주문 -->
	<insert id="insertOrder">
		INSERT INTO
		ORDER_TBL(
		ORDER_KEY_NUM,
		ORDER_NUM,
		GOODS_NUM,
		MEMBER_NUM,
		SELLER_NUM,
		ORDER_STATUS,
		ORDER_CONTACT,
		ORDER_EMAIL,
		ORDER_DATE,
		ORDER_REQUEST,
		ORDER_PAY_TYPE,
		ORDER_NAME,
		ORDER_FORMAT,
		ORDER_RESOLUTION,
		ORDER_SIZE,
		ORDER_MODIFY_COUNT,
		ORDER_PERIOD,
		ORDER_IMAGE,
		SELLER_NICKNAME
		)
		
		VALUES(
		#{orderKeyNum},
		#{orderNum},
		#{goodsNum},
		#{memberNum},
		#{sellerNum},
		'1',
		#{orderContact},
		#{orderEmail},
		SYSDATE,
		#{orderRequest, jdbcType=VARCHAR},
		#{orderPayType},
		#{orderName},
		#{orderFormat, jdbcType=VARCHAR},
		#{orderResolution, jdbcType=VARCHAR},
		#{orderSize, jdbcType=VARCHAR},
		#{orderModifyCount,  jdbcType=VARCHAR},
		#{orderPeriod, jdbcType=VARCHAR},
		#{orderImage, jdbcType=VARCHAR},
		#{sellerNickname, jdbcType=VARCHAR}
		)
	</insert>
	
	<!-- <insert id="insertOrder">
		INSERT INTO
		ORDER_TBL(
		ORDER_KEY_NUM,
		ORDER_NUM,
		GOODS_NUM,
		MEMBER_NUM,
		SELLER_NUM,
		ORDER_STATUS,
		ORDER_CONTACT,
		ORDER_EMAIL,
		ORDER_DATE,
		ORDER_REQUEST,
		ORDER_PAY_TYPE,
		ORDER_NAME,
		ORDER_FORMAT,
		ORDER_RESOLUTION,
		ORDER_SIZE,
		ORDER_MODIFY_COUNT,
		ORDER_PERIOD,
		ORDER_IMAGE,
		SELLER_NICKNAME
		)
		
		VALUES(
		#{orderKeyNum},
		#{orderNum},
		#{goodsNum},
		#{memberNum},
		#{sellerNum},
		'1',
		#{orderContact},
		#{orderEmail},
		SYSDATE,
		#{orderRequest},
		#{orderPayType},
		#{orderName},
		#{orderFormat},
		#{orderResolution},
		#{orderSize},
		#{orderModifyCount},
		#{orderPeriod},
		#{orderImage},
		#{sellerNickname}
		)
	</insert> -->

	<!-- 회원 주문 옵션 -->
	<insert id="insertOrderOpt">
		INSERT INTO
		ORDER_OPT_TBL
		(
		ORDER_OPT_NUM,
		GOODS_NUM,
		ORDER_NUM,
		<!-- GOODS_OPT_CONTENT_NUM, -->
		ORDER_OPT_PRICE,
		ORDER_OPT_COUNT,
		ORDER_OPT_DATE,
		ORDER_OPT_STATUS,
		<!-- ORDER_OPT_REQUEST, -->
		ORDER_OPT_PAY_TYPE,
		ORDER_OPT_NAME
		)
		
		VALUES
		(
		#{orderOptNum},
		#{goodsNum},
		#{orderNum},
		<!-- #{goodsOptContentNum}, -->
		#{orderOptPrice}, 
		#{orderOptCount}, 
		SYSDATE,
		'1',
		<!-- #{orderOptRequest},  -->
		#{orderOptPayType}, 
		#{orderOptName}
		)
	</insert>

	<!-- 상태 변경 -->
	<update id="updateOrderStatus">
		UPDATE ORDER_TBL O
		SET ORDER_STATUS = #{orderStatus}
		
		<if test="orderStatus == 3">
			, ORDER_EXPIRATION_DATE = SYSDATE + (SELECT GOODS_PERIOD FROM GOODS_TBL G WHERE G.GOODS_NUM =O.GOODS_NUM )
		</if>
		
		WHERE ORDER_NUM = #{orderNum}
	</update>

	<!-- 옵션 상태 변경 -->
	<update id="updateOrderOptStatus">
		UPDATE ORDER_OPT_TBL
		SET ORDER_OPT_STATUS = #{ORDER_OPT_STATUS}
		WHERE ORDER_NUM = #{ORDER_NUM}
	</update>


	<!-- 완료 상태 변경 -->
	<update id="updateOrderStatusOk">
		UPDATE ORDER_TBL
		SET ORDER_STATUS = #{orderStatus},
		ORDER_DONE_DATE = SYSDATE
		WHERE ORDER_NUM = #{orderNum}
	</update>

	<!-- 완료 옵션 상태 변경 -->
	<update id="updateOrderOptStatusOk">
		UPDATE ORDER_OPT_TBL
		SET ORDER_OPT_STATUS = #{ORDER_OPT_STATUS}
		WHERE ORDER_NUM = #{ORDER_NUM}
	</update>

	<!-- 취소 상태 변경 -->
	<update id="updateOrderCancel">
		UPDATE ORDER_TBL
		SET ORDER_STATUS = #{orderStatus},
		ORDER_CANCLE_DATE = SYSDATE
		WHERE ORDER_NUM = #{orderNum}
	</update>

	<!-- 취소 옵션 상태 변경 -->
	<update id="updateOrderOptCancel">
		UPDATE ORDER_OPT_TBL
		SET ORDER_OPT_STATUS = #{ORDER_OPT_STATUS},
		ORDER_OPT_CANCLE_DATE = TO CHAR(SYSDATE, 'YYYY-MM-DD')
		WHERE ORDER_NUM = #{ORDER_NUM}
	</update>

	<!-- 주문 수정 -->
	<update id="updateOrder">
		UPDATE ORDER_TBL
		SET ORDER_EMAIL = #{orderEmail},
		ORDER_CONTACT = #{orderContact},
		ORDER_REQUEST = #{orderRequest}
		WHERE ORDER_NUM = #{orderNum}
	</update>


	<!-- 주문 옵션 수정 -->
	<update id="updateOrderOpt">
		UPDATE ORDER_OPT_TBL
		SET ORDER_OPT_PRICE = #{ORDER_OPT_PRICE},
		ORDER_OPT_COUNT = #{ORDER_OPT_COUNT},
		ORDER_OPT_REQUEST = #{ORDER_OPT_REQUEST}
		WHERE ORDER_NUM = #{ORDER_NUM}
	</update>
	
	
	<!-- order 1개와 order-option n개를 가져올 수 있는 resultMap -->
	<resultMap type="com.mycom.euum.order.bean.OrderBean" id="orderMap">
		<result property="orderKeyNum" column="order_Key_Num"/>
		<result property="orderNum" column="order_Num"/>
		<result property="goodsNum" column="goods_Num"/>
		<result property="memberNum" column="member_Num"/>
		<result property="sellerNum" column="seller_Num"/>
		<result property="orderStatus" column="order_Status"/>
		<result property="orderContact" column="order_Contact"/>
		<result property="orderEmail" column="order_Email"/>
		<result property="orderDate" column="order_Date"/>
		<result property="orderCancleDate" column="order_Cancle_Date"/>
		<result property="orderRequest" column="order_Request"/>
		<result property="orderPayType" column="order_Pay_Type"/>
		<result property="orderName" column="order_Name"/>
		<result property="orderFormat" column="order_Format"/>
		<result property="orderResolution" column="order_Resolution"/>
		<result property="orderSize" column="order_Size"/>
		<result property="orderModifyCount" column="order_Modify_Count"/>
		<result property="orderPeriod" column="order_Period"/>
		<result property="orderImage" column="order_Image"/>
		<result property="sellerNickname" column="seller_nickname"/>
		
		<collection property="optionList" resultMap="optionMap"/>
		
	</resultMap>
	
	<resultMap type="com.mycom.euum.order.bean.OrderOptionBean" id="optionMap">
		<result property="orderOptNum" column="order_opt_num"/>
		<result property="orderOptPrice" column="order_opt_price"/>
		<result property="orderOptCount" column="order_opt_count"/>
		<result property="orderOptDate" column="order_opt_date"/>
		<result property="orderOptCancleDate" column="order_opt_cancle_date"/>
		<result property="orderOptStatus" column="order_opt_status"/>
		<result property="orderOptPayType" column="order_opt_pay_type"/>
		<result property="orderOptName" column="order_opt_name"/>
	</resultMap>

	<!-- 회원의 주문 내역 리스트 -->
	<select id="selectOrderListByMember" resultType="com.mycom.euum.order.bean.OrderBean">
		SELECT  O.ORDER_NUM,
        G.GOODS_NAME,
		ORDER_KEY_NUM,
		SELLER_NICKNAME,
		G.GOODS_NUM,
		G.MEMBER_NUM,
		O.SELLER_NUM,
		ORDER_STATUS,
		ORDER_CONTACT,
		ORDER_EMAIL,
		ORDER_DATE,
		ORDER_REQUEST,
		ORDER_PAY_TYPE,
		ORDER_NAME,
		ORDER_FORMAT,
		ORDER_RESOLUTION,
		ORDER_SIZE,
		ORDER_MODIFY_COUNT,
		ORDER_PERIOD,
		ORDER_IMAGE,
        ORDER_EXPIRATION_DATE,
        ORDER_PRICE,
        ORDER_REQUEST,
        ORDER_CANCLE_DATE
		FROM ORDER_TBL O INNER JOIN GOODS_TBL G 
        ON O.GOODS_NUM=G.GOODS_NUM
        inner join (select order_num, sum(order_opt_price) as "ORDER_PRICE" from order_opt_tbl group by order_num) p
        on o.order_num=p.order_num
		and O.MEMBER_NUM = #{memberNum}
		order by order_date desc
		
	</select>
	
	<!-- 셀러의 주문 내역 리스트 -->
	<select id="selectOrderListBySeller" resultType="com.mycom.euum.order.bean.OrderBean">
		SELECT  O.ORDER_NUM,
        G.GOODS_NAME,
		ORDER_KEY_NUM,
		SELLER_NICKNAME,
		G.GOODS_NUM,
		G.MEMBER_NUM,
		O.SELLER_NUM,
		ORDER_STATUS,
		ORDER_CONTACT,
		ORDER_EMAIL,
		ORDER_DATE,
		ORDER_REQUEST,
		ORDER_PAY_TYPE,
		ORDER_NAME,
		ORDER_FORMAT,
		ORDER_RESOLUTION,
		ORDER_SIZE,
		ORDER_MODIFY_COUNT,
		ORDER_PERIOD,
		ORDER_IMAGE,
        ORDER_EXPIRATION_DATE,
        ORDER_PRICE,
        ORDER_REQUEST,
        ORDER_CANCLE_DATE
		FROM ORDER_TBL O INNER JOIN GOODS_TBL G 
        ON O.GOODS_NUM=G.GOODS_NUM
        inner join (select order_num, sum(order_opt_price) as "ORDER_PRICE" from order_opt_tbl group by order_num) p
        on o.order_num=p.order_num
		and O.SELLER_NUM = #{sellerNum}
		order by order_date desc
		
	</select>



	<!-- 접수 내역 리스트 -->
	<select id="selectSellerList"
		resultType="com.mycom.euum.order.bean.OrderBean">
		SELECT order_key_num,
		order_num,
		goods_num,
		member_num,
		seller_num,
		order_status,
		order_contact,
		order_email,
		order_date,
		order_request,
		order_pay_type,
		order_name,
		order_format,
		order_resolution,
		order_size,
		order_modify_count,
		order_period,
		order_image,
		order_opt_num,
		goods_num,
		goods_option_content_num,
		order_opt_price,
		order_opt_count,
		order_opt_date,
		order_opt_status,
		order_opt_request,
		order_opt_pay_type,
		order_option_name
		FROM ORDER_TBL, ORDER_OPT_TBL
		WHERE SELLER_NUM = #{sellerNum}
	</select>

	<!-- 어드민 주문 관리 내역 -->
	<select id="selectAdminOrderList"
		resultType="com.mycom.euum.order.bean.OrderBean">
		SELECT 
        G.GOODS_NAME,
		ORDER_KEY_NUM,
		o.ORDER_NUM,
		SELLER_NICKNAME,
		G.GOODS_NUM,
		MEMBER_NUM,
		ORDER_STATUS,
		ORDER_CONTACT,
		ORDER_EMAIL,
		ORDER_DATE,
		ORDER_REQUEST,
		ORDER_PAY_TYPE,
		ORDER_NAME,
		ORDER_FORMAT,
		ORDER_RESOLUTION,
		ORDER_SIZE,
		ORDER_MODIFY_COUNT,
		ORDER_PERIOD,
		ORDER_IMAGE,
        ORDER_DATE+ORDER_PERIOD as "ORDER_EXPIRATION_DATE",
        ORDER_PRICE
        
		FROM ORDER_TBL O INNER JOIN GOODS_TBL G 
        ON O.GOODS_NUM=G.GOODS_NUM
        inner join (select order_num, sum(order_opt_price) as "ORDER_PRICE" from order_opt_tbl group by order_num) p
        on o.order_num=p.order_num
	</select>


	
	

	<!-- ORDER_NUM 조건으로 레코드 1개 가져오기 -->
	<!-- <select id="selectOrder" resultType="com.mycom.euum.order.bean.OrderBean"> -->
	<select id="selectOrder" resultMap="orderMap">
		SELECT
		order_key_num,
		o.order_num,
		o.goods_num,
		member_num,
		order_status,
		order_contact,
		order_email,
		order_date,
		order_request,
		order_pay_type,
		order_name,
		order_format,
		order_resolution,
		order_size,
		order_modify_count,
		order_period,
		order_image,
		order_opt_num,
		o.goods_num,
		goods_opt_content_num,
		order_opt_price,
		order_opt_count,
		order_opt_date,
		order_opt_status,
		order_opt_request,
		order_opt_pay_type,
		order_opt_name,
		o.SELLER_NICKNAME
		
		FROM
		order_tbl o,
		order_opt_tbl p
		
		where o.order_num = p.order_num
		and o.ORDER_NUM = #{orderNum}
	</select>



</mapper>